<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}ì²­ë…„ ì£¼ê±° ì†”ë£¨ì…˜{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ê³µí†µ ë ˆì´ì•„ì›ƒ CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

  <!-- ğŸ”¥ í˜ì´ì§€ ê°œë³„ CSS ë¡œë”© -->
  {% block page_css %}{% endblock %}
</head>

<body>

  <!-- NAVIGATION -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom py-2">
    <div class="container-fluid px-4">

      <a class="navbar-brand" href="{{ url_for('index.index') }}">
        <img src="{{ url_for('static', filename='image/logo2.png') }}"
             alt="ì²­ë…„ ì£¼ê±° ì†”ë£¨ì…˜ ë¡œê³ "
             style="height:40px; width:auto;">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="topNav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item ms-3">
            <a class="nav-link" href="{{ url_for('predict.predict_search') }}">ì „ì›”ì„¸ ì˜ˆì¸¡</a>
          </li>
          <li class="nav-item ms-3">
            <a class="nav-link" href="{{ url_for('support.support_search') }}">ì •ë¶€ì§€ì› ì •ì±…</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('support.llama3_page') }}">LLaMA3</a>
          </li>
          <li class="nav-item ms-3">
            <a class="nav-link"
               href="#"
               data-bs-toggle="modal"
               data-bs-target="#genaiModal">
              ìƒì„±í˜• AI
            </a>
          </li>
          <li class="nav-item ms-3">
            <a class="nav-link" href="{{ url_for('login.login') }}">ë¡œê·¸ì¸</a>
          </li>
          <li class="nav-item ms-3">
            <a class="nav-link" href="{{ url_for('login.signup') }}">íšŒì›ê°€ì…</a>
          </li>
        </ul>
      </div>

    </div>
  </nav>

  <!-- ğŸ”¥ ëª¨ë“  í˜ì´ì§€ í’€ìŠ¤í¬ë¦° ì§€ì› -->
  <main class="{% block main_class %}{% endblock %}">
    {% block content %}
    {% endblock %}
  </main>

  <!-- ğŸ”¥ ìƒì„±í˜• AI ëª¨ë‹¬ (ì±—ë´‡ UI) -->
  <div class="modal fade" id="genaiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 rounded-4">

        <div class="modal-header bg-primary text-white border-0 rounded-top-4">
          <h5 class="modal-title fw-bold">ìƒì„±í˜• AI ë„ìš°ë¯¸</h5>
          <button type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>

        <div class="modal-body bg-light">

          <!-- ê¸°ëŠ¥ ì„ íƒ -->
          <div class="mb-3">
            <label class="form-label">ê¸°ëŠ¥ ì„ íƒ</label>
            <select id="genai-task" class="form-select">
              <option value="generate">í…ìŠ¤íŠ¸ ìƒì„±</option>
              <option value="translate">ë²ˆì—­</option>
              <option value="sentiment">ê°ì„±ë¶„ì„</option>
              <option value="ner">ê°œì²´ëª… ì¸ì‹</option>
              <option value="qa">ì •ì±… Q&A</option>
            </select>
          </div>

          <!-- QA ì „ìš© context ì…ë ¥ (ê¸°ë³¸ì€ ìˆ¨ê¹€) -->
          <div class="mb-3" id="genai-context-box" style="display:none;">
            <label class="form-label">Context (ì •ì±… ë‚´ìš©)</label>
            <textarea id="genai-context" class="form-control" rows="4"
                      placeholder="ì •ì±… ì „ë¬¸ ë˜ëŠ” ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
          </div>

          <!-- ğŸ‘‡ ì±„íŒ… íˆìŠ¤í† ë¦¬ ì˜ì—­ -->
          <div id="genai-chat-box"
               class="border rounded-3 p-3 mb-3 bg-white"
               style="height:260px; overflow-y:auto;">
            <div class="text-muted small">
              ìƒì„±í˜• AI ë„ìš°ë¯¸ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ì–´ë³´ì„¸ìš”.
            </div>
          </div>

          <!-- ğŸ‘‡ ì…ë ¥ ì˜ì—­ -->
          <div class="d-flex gap-2">
            <textarea id="genai-input"
                      class="form-control"
                      rows="2"
                      placeholder="í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì§ˆë¬¸, ë²ˆì—­í•  ë¬¸ì¥ ë“±)"></textarea>
            <button id="genai-send" class="btn btn-primary flex-shrink-0">
              ë³´ë‚´ê¸°
            </button>
          </div>

          <!-- ìƒíƒœ/ì—ëŸ¬ ë©”ì‹œì§€ -->
          <div id="genai-loading" class="mt-2 small text-muted" style="display:none;">
            ğŸ”„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...
          </div>

          <div id="genai-error" class="mt-2 small text-danger" style="display:none;"></div>

        </div> <!-- /modal-body -->

      </div> <!-- /modal-content -->
    </div>   <!-- /modal-dialog -->
  </div>     <!-- /modal -->

  <!-- FOOTER ------------------------------------------------------------ -->
  <section class="logo-bar">
    <div class="logo-slider">
      <div class="logo-track">
        {% set logos = [
          ('logo_gov24.png','https://www.gov.kr/'),
          ('logo_mailmove.png','https://www.gov.kr/mw/AA020InfoCappView.do?CappBizCD=17210000001'),
          ('logo_movein.png','https://www.gov.kr/mw/AA020InfoCappView.do?CappBizCD=13100000016'),
          ('logo_juso.png','https://www.juso.go.kr/openIndexPage.do'),
          ('logo_iros.png','https://www.iros.go.kr/index.jsp'),
          ('logo_kepco.png','https://online.kepco.co.kr/'),
          ('logo_seoulgas.png','https://www.seoulgas.co.kr/front/main.do'),
          ('logo_lh.png','https://www.lh.or.kr/'),
          ('logo_sh.png','https://www.sh.co.kr/'),
          ('logo_reb.png','https://www.reb.or.kr/'),
          ('logo_arisu.png','https://i121.seoul.go.kr/cs/cyber/front/main/NR_index.do'),
          ('logo_molit.png','https://www.molit.go.kr/')
        ] %}

        {% for logo, url in logos %}
        <a href="{{ url }}" target="_blank">
          <img src="{{ url_for('static', filename='image/' ~ logo) }}" class="logo">
        </a>
        {% endfor %}
        {% for logo, url in logos %}
        <a href="{{ url }}" target="_blank">
          <img src="{{ url_for('static', filename='image/' ~ logo) }}" class="logo">
        </a>
        {% endfor %}

      </div>
    </div>
  </section>

  <footer class="footer-section">
    <div class="container px-4">

      <div class="footer-flex">

        <!-- ì™¼ìª½: ë¡œê³  -->
        <div class="footer-left">
          <img src="{{ url_for('static', filename='image/logo2.png') }}"
               alt="ì²­ë…„ ì£¼ê±° ì†”ë£¨ì…˜ ë¡œê³ "
               style="height:60px; width:auto;">
        </div>

        <!-- ê°€ìš´ë°: ìƒë‹´ì„¼í„°/ì „í™” + ë©”ë‰´ + COPYRIGHT -->
        <div class="footer-center">

          <div class="footer-top">
            ì²­ë…„ì£¼ê±° ìƒë‹´ì„¼í„° <strong>02-987-6543</strong> â”‚ ë°ì´í„°Â·ì‹œì„¸ ë¬¸ì˜ <strong>02-111-2222</strong>
          </div>

          <div class="footer-menu mt-2">
            <a href="#">íšŒì‚¬ì†Œê°œ</a>
            <a href="#">ì´ìš©ì•ˆë‚´</a>
            <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
          </div>

          <div class="footer-bottom mt-2">
            COPYRIGHT Â© 2025 YOUTH HOUSING SOLUTION. ALL RIGHTS RESERVED.
          </div>

        </div>

        <!-- ì˜¤ë¥¸ìª½: ë©”ë‰´ ë°”ë¡œê°€ê¸° -->
        <div class="footer-right">
          <div class="footer-dropdown">
            <button class="footer-dropdown-btn" id="dropdownToggle">ë©”ë‰´ ë°”ë¡œê°€ê¸° â–¾</button>

            <div class="footer-dropdown-list" id="dropdownMenu">
              <a href="{{ url_for('index.index') }}">ë©”ì¸í˜ì´ì§€</a>
              <a href="{{ url_for('predict.predict_search') }}">ì „ì›”ì„¸ ì˜ˆì¸¡</a>
              <a href="{{ url_for('support.support_search') }}">ì •ë¶€ì§€ì› ì •ì±…</a>
              <a href="{{ url_for('inquiry.inquiry_list') }}">ë¬¸ì˜í•˜ê¸°</a>
            </div>
          </div>
        </div>

      </div>

    </div>
  </footer>

  <!-- FOOTER ë“œë¡­ë‹¤ìš´ JS -->
  <script>
    const toggleBtn = document.getElementById("dropdownToggle");
    const menu = document.getElementById("dropdownMenu");

    if (toggleBtn && menu) {
      toggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("show");
      });

      document.addEventListener("click", () => {
        menu.classList.remove("show");
      });
    }
  </script>

  <!-- ğŸ”¥ ìƒì„±í˜• AI ëª¨ë‹¬ JS (ì±—ë´‡ ë™ì‘) -->
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const taskEl = document.getElementById("genai-task");
    const contextBox = document.getElementById("genai-context-box");
    const contextEl = document.getElementById("genai-context");
    const inputEl = document.getElementById("genai-input");
    const sendBtn = document.getElementById("genai-send");
    const chatBox = document.getElementById("genai-chat-box");
    const loadingEl = document.getElementById("genai-loading");
    const errorEl = document.getElementById("genai-error");

    if (!taskEl) return;  // ëª¨ë‹¬ ì—†ëŠ” í˜ì´ì§€ì—ì„œ ì—ëŸ¬ ë°©ì§€

    // ê¸°ëŠ¥ ì„ íƒ ì‹œ QAì¼ ë•Œë§Œ context ë³´ì´ê¸°
    taskEl.addEventListener("change", () => {
      if (taskEl.value === "qa") {
        contextBox.style.display = "block";
      } else {
        contextBox.style.display = "none";
        contextEl.value = "";
      }
    });

    // ë§í’ì„  ì¶”ê°€ í—¬í¼
function addBubble(text, role) {
  const wrap = document.createElement("div");
  wrap.classList.add("mb-2", "d-flex");

  const bubble = document.createElement("div");
  // ê³µí†µ ë§í’ì„  í´ë˜ìŠ¤
  bubble.classList.add("chat-bubble", "small");

  if (role === "user") {
    // ì˜¤ë¥¸ìª½ ì •ë ¬ + ì‚¬ìš©ì ìŠ¤íƒ€ì¼
    wrap.classList.add("justify-content-end");
    bubble.classList.add("user", "bg-primary", "text-white", "rounded-3", "shadow-sm");
  } else {
    // ì™¼ìª½ ì •ë ¬ + ì–´ì‹œìŠ¤í„´íŠ¸ ìŠ¤íƒ€ì¼
    wrap.classList.add("justify-content-start");
    bubble.classList.add("assistant", "rounded-3", "shadow-sm");
    // bg-white / text ìƒ‰ìƒì€ CSSì—ì„œ ì§€ì •
  }

  bubble.textContent = text;
  wrap.appendChild(bubble);

  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;
}


    // âœ… í‚¤ë³´ë“œ/ì¤‘ë³µ ë°©ì§€ì— í•„ìš”í•œ ìƒíƒœê°’ë§Œ ì¶”ê°€ (ë‹¤ë¥¸ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ)
    let isComposing = false;
    let sending = false;

    inputEl.addEventListener("compositionstart", () => {
      isComposing = true;
    });

    inputEl.addEventListener("compositionend", () => {
      isComposing = false;
    });

    async function sendMessage() {
      if (sending) return;      // âœ… ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      sending = true;

      const task = taskEl.value;
      const text = (inputEl.value || "").trim();
      const context = (contextEl.value || "").trim();

      errorEl.style.display = "none";
      errorEl.textContent = "";

      if (!text) {
        errorEl.textContent = "í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        errorEl.style.display = "block";
        sending = false;
        return;
      }
      if (task === "qa" && !context) {
        errorEl.textContent = "ì •ì±… Q&AëŠ” context(ì •ì±… ë‚´ìš©)ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
        errorEl.style.display = "block";
        sending = false;
        return;
      }

      // ì‚¬ìš©ì ë§í’ì„  ì¶”ê°€
      addBubble(text, "user");
      inputEl.value = "";

      loadingEl.style.display = "block";

      try {
        const resp = await fetch("{{ url_for('support.genai_chat_api') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ task, text, context })
        });

        loadingEl.style.display = "none";

        // âœ… (ìˆ˜ì •) JSONì´ ì•„ë‹Œ ì‘ë‹µ(404/500 HTML)ë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        const contentType = resp.headers.get("content-type") || "";
        let data = null;
        let rawText = "";

        if (contentType.includes("application/json")) {
          data = await resp.json();
        } else {
          rawText = await resp.text();
        }

        if (!resp.ok) {
          errorEl.textContent =
            (data && data.error) ||
            `HTTP ${resp.status} ${resp.statusText}\n` + (rawText ? rawText.slice(0, 300) : "(no body)");
          errorEl.style.display = "block";
          return;
        }

        addBubble((data && data.answer) || "(ë¹ˆ ì‘ë‹µ)", "bot");
      } catch (e) {
        loadingEl.style.display = "none";
        errorEl.textContent = "ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + (e?.message || e);
        errorEl.style.display = "block";
        console.error(e);
      } finally {
        sending = false;        // âœ… ë¬´ì¡°ê±´ ë½ í•´ì œ
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        // âœ… í•œê¸€ ì¡°í•© ì¤‘ì´ë©´ Enter ë¬´ì‹œ
        if (isComposing || e.isComposing) return;

        e.preventDefault();
        sendMessage();
      }
    });
  });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
